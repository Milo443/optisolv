{% extends 'linear_programming/base.html' %}
{% load static %}

{% block title %}M√©todo Gr√°fico - OptiSolve{% endblock %}

{% block content %}
<h1 class="mb-4">M√©todo Gr√°fico (2 Variables)</h1>

<div class="row">
    <div class="col-md-5">
        
        <div class="card mb-4">
            <div class="card-header bg-success text-white">1. Definir Problema</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="objective_type" class="form-label">Objetivo de Optimizaci√≥n</label>
                        <select class="form-select" id="objective_type" name="objective_type" required>
                            <option value="MAX" {% if input_data.objective_type == 'MAX' %}selected{% endif %}>Maximizar</option>
                            <option value="MIN" {% if input_data.objective_type == 'MIN' %}selected{% endif %}>Minimizar</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="objective_func" class="form-label">Funci√≥n Objetivo (Z)</label>
                        <input type="text" class="form-control" id="objective_func" name="objective_func" 
                               placeholder="Ej: 8*x1 + 10*x2" required 
                               value="{{ input_data.objective_func|default:'' }}">
                    </div>
                    
                    <label class="form-label">Restricciones</label>
                    
                    <div id="restrictions-container">
                        </div>
                    
                    <div class="form-text mb-3">Recuerda que x1, x2 ‚â• 0 (no negatividad)</div>
                    
                    <button id="add-restriction" type="button" class="btn btn-outline-secondary btn-sm mb-3">
                        + A√±adir Restricci√≥n
                    </button>

                    
                    <button type="submit" class="btn btn-success w-100">2. Resolver Gr√°ficamente</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header bg-dark text-white">Gr√°fico de la Regi√≥n Factible</div>
            <div class="card-body">
                <canvas id="simplexChart" style="height: 400px; width:400px"></canvas>
            
            </div>
            <button id="download-chart" type="button" class="btn btn-sm btn-light">
                Descargar PNG ‚¨áÔ∏è
            </button>

        </div>
    </div>

    <div class="col-12 mt-4">
        {% if results %}
        <div class="card">
            <div class="card-header bg-info text-dark">3. Resultados y V√©rtices</div>
            <div class="card-body">
                {% if results.error %}
                    <div class="alert alert-danger">{{ results.error }}</div>
                {% else %}
                    <p class="h5 text-success">üéâ Soluci√≥n √ìptima:</p>
                    <p class="fs-4">Z = {{ results.optimal_value|floatformat:2 }}</p>
                    <p>Punto √≥ptimo:</p>
                    <ul>
                        <li>X1 = {{ results.optimal_point.0|floatformat:2 }}</li>
                        <li>X2 = {{ results.optimal_point.1|floatformat:2 }}</li>
                        
                    </ul>
                    
                    <h5 class="mt-4">V√©rtices Factibles:</h5>
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr><th>Punto</th><th>X1</th><th>X2</th><th>Valor Z</th><th>√ìptimo</th></tr>
                        </thead>
                        <tbody>
                            {% for vertex in results.vertices %}
                            <tr class="{% if vertex.is_optimal %}table-success fw-bold{% endif %}">
                                <td>{{ vertex.Punto }}</td>
                                <td>{{ vertex.X1|floatformat:2 }}</td>
                                <td>{{ vertex.X2|floatformat:2 }}</td>
                                <td>{{ vertex.Z|floatformat:2 }}</td>
                                <td>{% if vertex.is_optimal %}‚úÖ{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>


</div>
{% endblock %}

{% block extra_js %}
<script>
    // üåü SOLUCI√ìN: Usamos la variable SERIALIZADA de Python
    // La inyecci√≥n es segura porque usamos |safe, y JSON.parse recibe una cadena JSON v√°lida.
    const savedRestrictionsString = '{{ restrictions_json|safe }}';
    
    let savedRestrictions = [];
    try {
        savedRestrictions = JSON.parse(savedRestrictionsString);
    } catch (e) {
        console.error("Error al parsear las restricciones guardadas (JSON roto).", e);
    }
    
    const container = document.getElementById('restrictions-container');
    const addButton = document.getElementById('add-restriction');
    let restrictionCount = 0; 

    // --- L√≥gica JavaScript para a√±adir, eliminar y rellenar restricciones ---
    
    function createRestrictionGroup(index, value = '') {
        const newGroup = document.createElement('div');
        newGroup.classList.add('input-group', 'mb-3', 'restriction-group');
        
        newGroup.innerHTML = `
            <span class="input-group-text">R${index}</span>
            <input type="text" class="form-control" name="restriction_${index}" 
                   placeholder="Ej: 5*x1 + 8*x2 <= 1000" required 
                   value="${value}">
            <button class="btn btn-outline-danger remove-restriction" type="button" data-index="${index}">
                -
            </button>
        `;
        return newGroup;
    }
    
    // Funci√≥n para actualizar los n√∫meros (R1, R2...) y el contador
    function updateIndices() {
        const groups = container.querySelectorAll('.restriction-group');
        
        groups.forEach((group, index) => {
            const newIndex = index + 1;
            const span = group.querySelector('.input-group-text');
            const input = group.querySelector('.form-control');
            const removeButton = group.querySelector('.remove-restriction');

            span.textContent = 'R' + newIndex;
            input.name = 'restriction_' + newIndex;
            removeButton.dataset.index = newIndex;

            // Ocultar/Mostrar el bot√≥n de eliminar
            if (groups.length <= 1) {
                removeButton.classList.add('d-none');
            } else {
                removeButton.classList.remove('d-none');
            }
        });

        restrictionCount = groups.length;
    }
    
    // Rellenar las restricciones al cargar (incluyendo las guardadas)
    function initializeRestrictions() {
        // Limpiar el contenedor antes de rellenar
        container.innerHTML = '';
        
        if (savedRestrictions.length > 0) {
            savedRestrictions.forEach((value, index) => {
                container.appendChild(createRestrictionGroup(index + 1, value));
            });
        } else {
            // Inicializar con 2 vac√≠as si no hay datos guardados
            container.appendChild(createRestrictionGroup(1, ''));
            container.appendChild(createRestrictionGroup(2, ''));
        }
        updateIndices();
    }
    
    // 1. Manejar la adici√≥n de una nueva restricci√≥n
    addButton.addEventListener('click', function() {
        restrictionCount++;
        container.appendChild(createRestrictionGroup(restrictionCount));
        updateIndices();
    });

    // 2. Manejar la eliminaci√≥n de una restricci√≥n (delegaci√≥n de eventos)
    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-restriction')) {
            const groupToRemove = e.target.closest('.restriction-group');
            
            if (container.querySelectorAll('.restriction-group').length > 1) {
                groupToRemove.remove();
                updateIndices();
            } else {
                alert("Debe haber al menos una restricci√≥n estructural.");
            }
        }
    });

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', initializeRestrictions);


    // =================================================================
    // 3. L√≥gica Chart.js para dibujar el gr√°fico
    // =================================================================
    
    const chartDataJson = {{ chart_data_json|safe }}; 
    
    if (chartDataJson && chartDataJson.lines) {
        const datasets = [];
        
        // 1. A√±adir las l√≠neas de restricci√≥n (rectas)
        chartDataJson.lines.forEach(line => {
            datasets.push({
                label: line.label,
                data: line.data,
                borderColor: line.color,
                borderWidth: 2,
                fill: false,
                pointRadius: 0, 
                showLine: true,
                tension: 0,
                parsing: false,
                type: 'line' 
            });
        });

        // 2. A√±adir los puntos (v√©rtices) de la regi√≥n factible
        if (chartDataJson.region_vertices) {
             const pointsData = chartDataJson.region_vertices.map(v => ({
                x: v[0],
                y: v[1]
            }));

            datasets.push({
                label: 'V√©rtices Factibles',
                data: pointsData,
                backgroundColor: 'rgba(50, 200, 50, 1)', 
                pointRadius: 6,
                pointStyle: 'circle',
                showLine: false,
                type: 'scatter'
            });
        }
        
        const maxScale = chartDataJson.max_scale || 100;
        
        const ctx = document.getElementById('simplexChart').getContext('2d');
        
        new Chart(ctx, {
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'X1' },
                        min: 0,
                        max: maxScale
                    },
                    y: {
                        type: 'linear',
                        title: { display: true, text: 'X2' },
                        min: 0,
                        max: maxScale
                    }
                },
                plugins: {
                    legend: { display: true },
                    title: { display: true, text: 'Regi√≥n de Soluciones Factibles' }
                }
            }
        });
        // =================================================================
        // 4. L√≥gica de Descarga de Gr√°fico
        // =================================================================
        
        const downloadButton = document.getElementById('download-chart');
        
        if (downloadButton) {
            downloadButton.addEventListener('click', function() {
                // 1. Obtener el elemento canvas
                const canvas = document.getElementById('simplexChart');
                
                // 2. Convertir el contenido del canvas a una URL de datos (formato base64)
                // Se usa 'image/png' para un formato de alta calidad
                const imageURL = canvas.toDataURL('image/png', 1.0);
                
                // 3. Crear un enlace temporal para forzar la descarga
                const a = document.createElement('a');
                a.href = imageURL;
                a.download = 'OptiSolve_Metodo_Grafico.png'; // Nombre del archivo
                
                // 4. Simular el clic en el enlace y luego eliminarlo
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }
    }
</script>
{% endblock %}